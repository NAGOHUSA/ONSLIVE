<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Space Weather • ournightsky.us</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0a0e17;--card:rgba(20,25,45,0.75);--border:rgba(100,120,255,0.15);
      --text:#e6edf3;--text-muted:#94a3b8;--cyan:#00d4ff;--purple:#a855f7;
      --gold:#fbbf24;--red:#ef4444;--green:#10b981;
      --gradient:linear-gradient(135deg,#1e1b4b,#0f172a);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;min-height:100vh;
      color:var(--text);background:var(--gradient) fixed;line-height:1.6;}
    .container{max-width:1400px;margin:0 auto;padding:0 1rem;}
    header{position:sticky;top:0;z-index:1000;backdrop-filter:blur(20px);
      background:rgba(10,14,23,0.9);border-bottom:1px solid var(--border);padding:1rem 0;}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    h1{font-size:clamp(1.8rem,6vw,2.5rem);background:linear-gradient(135deg,var(--cyan),var(--purple));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    #refresh-btn{background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;
      padding:0.6rem 1.2rem;border-radius:40px;cursor:pointer;font-weight:600}
    .hero{margin:2rem auto;text-align:center;padding:clamp(1.5rem,5vw,2.5rem);background:var(--card);
      border-radius:24px;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .gauge-container{width:min(90vw,300px);height:min(50vw,170px);margin:1.5rem auto;position:relative}
    .gauge-value{font-weight:800;position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);pointer-events:none}
    .needle{position:absolute;bottom:12%;left:50%;width:2px;height:38%;background:var(--red);
      transform-origin:bottom center;transform:translateX(-50%) rotate(-90deg);transition:transform 1s,background .4s}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1.5rem;margin-top:2rem}
    .card{background:var(--card);border-radius:20px;padding:1.5rem;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .map-controls{position:absolute;top:12px;right:12px;z-index:1000;display:flex;gap:8px}
    .map-btn{background:rgba(0,0,0,0.7);color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer}
    .map-btn.active{background:var(--purple)}
    .data-item{padding:0.8rem;border-radius:8px;margin:0.5rem 0;background:rgba(255,255,255,0.03);border-left:4px solid var(--gold)}
    .alert-item{border-left-color:var(--red)}
    .loading{padding:2rem;text-align:center;color:var(--text-muted)}
    .error{color:var(--red)}
    footer{text-align:center;padding:3rem 1rem;margin-top:4rem;color:var(--text-muted);border-top:1px solid var(--border)}
    @media(max-width:768px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1><i class="fas fa-satellite"></i> live.ournightsky.us 1.0</h1>
      <div style="display:flex;gap:1rem;align-items:center;color:var(--text-muted)">
        <span>Last updated: <strong id="update-time">--:--</strong></span>
        <button id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h2><i class="fas fa-compass"></i> Current Space Weather Activity</h2>
      <div class="gauge-container" id="kp-gauge">
        <svg viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="kp-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient>
          </defs>
          <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"></path>
          <path id="kp-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#kp-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
          <circle cx="100" cy="100" r="8" fill="#fff"></circle>
          <text x="100" y="65" text-anchor="middle" class="gauge-value" id="kp-value">--</text>
        </svg>
        <div class="needle" id="kp-needle"></div>
      </div>
      <p id="aurora-message" style="margin-top:1rem;color:var(--text-muted)">Loading aurora summary...</p>
    </section>

    <section class="card" style="grid-column:1/-1;position:relative">
      <h2><i class="fas fa-map"></i> Live Aurora Oval Map</h2>
      <div style="position:relative">
        <div class="map-controls">
          <button class="map-btn active" id="btn-north">Northern</button>
          <button class="map-btn" id="btn-south">Southern</button>
        </div>
        <div id="aurora-map" style="height:360px;border-radius:12px;background:#000"></div>
      </div>
      <small style="display:block;margin-top:8px;text-align:center;color:var(--text-muted)">Real-time aurora forecast overlays</small>
    </section>

    <div class="grid">
      <div class="card">
        <h2><i class="fas fa-sun"></i> Solar Activity</h2>
        <div id="solar-data" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
      </div>

      <div class="card">
        <h2><i class="fas fa-radiation"></i> Solar Radiation (X-ray)</h2>
        <div class="gauge-container" id="xray-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="xray-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="xray-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#xray-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="xray-value">--</text>
          </svg>
          <div class="needle" id="xray-needle"></div>
        </div>
        <div id="xray-info" class="loading"></div>
      </div>

      <div class="card">
        <h2><i class="fas fa-magnet"></i> Geomagnetic Storms (Dst)</h2>
        <div class="gauge-container" id="dst-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="dst-grad"><stop offset="0%" stop-color="#ef4444"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#10b981"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="dst-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#dst-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="dst-value">--</text>
          </svg>
          <div class="needle" id="dst-needle"></div>
        </div>
        <div id="dst-info" class="loading"></div>
      </div>

      <div class="card">
        <h2><i class="fas fa-satellite-dish"></i> ISS Tracking</h2>
        <div id="iss-map" style="height:300px;border-radius:12px;background:#000"></div>
        <small style="display:block;margin-top:8px;color:var(--text-muted)">Uses wheretheiss.at when online</small>
      </div>

      <div class="card">
        <h2><i class="fas fa-cloud-aurora"></i> Aurora Forecast</h2>
        <div id="aurora-forecast" class="loading">Loading...</div>
      </div>

      <div class="card">
        <h2><i class="fas fa-newspaper"></i> Latest Space News</h2>
        <div id="news-feed" class="loading">Loading...</div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h2><i class="fas fa-info-circle"></i> System Status</h2>
        <div id="system-status" class="loading">Checking...</div>
      </div>
    </div>
  </main>

  <footer>
    <p>Part of <a href="https://ournightsky.us" style="color:var(--cyan)">ournightsky.us</a> • Data: local files & NOAA</p>
    <p>Auto-refresh every 2 minutes • Last run: <span id="last-run">--</span></p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Elements
    const updateTime = document.getElementById('update-time');
    const refreshBtn = document.getElementById('refresh-btn');
    const lastRunEl = document.getElementById('last-run');

    const kpValueEl = document.getElementById('kp-value');
    const kpArc = document.getElementById('kp-arc');
    const kpNeedle = document.getElementById('kp-needle');
    const auroraMessageEl = document.getElementById('aurora-message');

    const dstValueEl = document.getElementById('dst-value');
    const dstArc = document.getElementById('dst-arc');
    const dstNeedle = document.getElementById('dst-needle');
    const dstInfoEl = document.getElementById('dst-info');

    const xrayValueEl = document.getElementById('xray-value');
    const xrayArc = document.getElementById('xray-arc');
    const xrayNeedle = document.getElementById('xray-needle');
    const xrayInfoEl = document.getElementById('xray-info');

    const solarDataEl = document.getElementById('solar-data');
    const auroraForecastEl = document.getElementById('aurora-forecast');
    const newsFeedEl = document.getElementById('news-feed');
    const systemStatusEl = document.getElementById('system-status');

    // Leaflet maps
    let mapAurora, auroraLayerNorth, auroraLayerSouth;
    let mapISS, issMarker;
    let tecLayer, mapTEC;

    function formatTime(d=new Date()){
      return d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
    }
    function formatDate(d=new Date()){
      return d.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    }

    // Local-first fetch helper
    async function fetchLocalOrRemote(localPath, remoteUrl=null) {
      // Try local first (use caching-busting query)
      if (localPath) {
        try {
          const res = await fetch(localPath + '?t=' + Date.now());
          if (res.ok) {
            const txt = await res.text();
            try { return JSON.parse(txt); } catch(e) { return txt; }
          }
        } catch(e) { console.debug('local fetch failed', localPath, e); }
      }
      if (!remoteUrl) return null;
      try {
        const res2 = await fetch(remoteUrl + '?t=' + Date.now());
        if (!res2.ok) return null;
        const txt = await res2.text();
        try { return JSON.parse(txt); } catch(e) { return txt; }
      } catch(e){ console.debug('remote fetch failed', remoteUrl, e); return null; }
    }

    // Gauge helper
    function updateGauge(valueEl, arcEl, needleEl, val, min=0, max=9, unit='', reverse=false) {
      const numeric = Number(val);
      let percent = Number.isFinite(numeric) ? (numeric - min) / (max - min) : 0;
      if (reverse) percent = 1 - percent;
      percent = Math.max(0, Math.min(1, percent));
      const deg = percent * 180 - 90;
      valueEl.textContent = (Number.isFinite(numeric) ? (Math.round(numeric*10)/10) : '--') + (unit || '');
      arcEl.setAttribute('stroke-dasharray', `${percent * 251.3}, 251.3`);
      needleEl.style.transform = `translateX(-50%) rotate(${deg}deg)`;
      needleEl.style.background = percent > 0.66 ? 'var(--red)' : percent > 0.33 ? 'var(--gold)' : 'var(--green)';
    }

    // Convert GOES-like flux number to human class (A/B/C/M/X)
    function fluxToClass(flux) {
      const f = parseFloat(flux);
      if (!Number.isFinite(f) || f <= 0) return 'A0.0';
      const exponent = Math.floor(Math.log10(f));
      const mantissa = f / Math.pow(10, exponent);
      const classes = { -8: 'A', -7: 'B', -6: 'C', -5: 'M', -4: 'X' };
      const letter = classes[exponent] || 'X';
      return letter + mantissa.toFixed(1);
    }

    // Initialize maps
    function initMaps() {
      mapAurora = L.map('aurora-map', { center:[80,0], zoom:2, minZoom:2, maxZoom:5, worldCopyJump:true });
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(mapAurora);
      auroraLayerNorth = L.imageOverlay('https://services.swpc.noaa.gov/products/aurora/aurora-northern-hemisphere.jpg', [[90,-180],[30,180]], { opacity:0.7 }).addTo(mapAurora);
      auroraLayerSouth = L.imageOverlay('https://services.swpc.noaa.gov/products/aurora/aurora-southern-hemisphere.jpg', [[-30,-180],[-90,180]], { opacity:0.7 });

      mapISS = L.map('iss-map', { center:[0,0], zoom:3, minZoom:2, maxZoom:8 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'OpenStreetMap' }).addTo(mapISS);
      const issIcon = L.icon({ iconUrl:'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/ISS_insignia.svg/120px-ISS_insignia.svg.png', iconSize:[48,48] });
      issMarker = L.marker([0,0], { icon: issIcon }).addTo(mapISS);

      mapTEC = L.map('tec-map', { center:[0,0], zoom:2, minZoom:1, maxZoom:6, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'OpenStreetMap' }).addTo(mapTEC);
      tecLayer = L.imageOverlay('https://services.swpc.noaa.gov/products/noaa-maps/glotec.png', [[90,-180],[-90,180]], { opacity:0.8 }).addTo(mapTEC);
    }

    // Buttons to switch north/south
    document.getElementById('btn-north').addEventListener('click', () => {
      try { mapAurora.setView([80,0],2); auroraLayerNorth.addTo(mapAurora); auroraLayerSouth.remove(); } catch(e){}
      document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-north').classList.add('active');
    });
    document.getElementById('btn-south').addEventListener('click', () => {
      try { mapAurora.setView([-80,0],2); auroraLayerSouth.addTo(mapAurora); auroraLayerNorth.remove(); } catch(e){}
      document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-south').classList.add('active');
    });

    // Display helpers
    function showError(el, msg) { el.classList.remove('loading'); el.innerHTML = '<div class="error">' + msg + '</div>'; }

    // Parse and render noaa-data.json (local file)
    function renderNOAAData(noaa) {
      // KP (noaa.kpIndex is array-of-arrays; pick last)
      try {
        if (noaa && Array.isArray(noaa.kpIndex) && noaa.kpIndex.length) {
          const last = noaa.kpIndex[noaa.kpIndex.length - 1];
          // Example row: [ "2025-12-05 00:00:00.000", "3.33", "18", "7" ]
          const kp = parseFloat(last[1]);
          updateGauge(kpValueEl, kpArc, kpNeedle, kp, 0, 9);
        } else {
          kpValueEl.textContent = '—';
        }
      } catch(e){ kpValueEl.textContent = '—'; }

      // Solar wind (sample is an array)
      try {
        if (noaa && noaa.solarWind && Array.isArray(noaa.solarWind)) {
          // sample: ["2025-12-08 01:15:00.000","0.63","420.6","181889"]
          const sample = noaa.solarWind;
          const time = sample[0] || '';
          // best-effort: speed likely at index 2, density maybe index 3 or 6 in other formats
          const speed = sample[2] ?? sample[1] ?? '—';
          const other = sample[1] ?? sample[3] ?? '';
          solarDataEl.classList.remove('loading');
          solarDataEl.innerHTML = `<div class="data-item"><strong>Solar wind sample:</strong> ${time}</div>
            <div class="data-item">Speed: ${speed} km/s • Extra: ${other}</div>`;
        } else {
          solarDataEl.classList.remove('loading');
          solarDataEl.innerHTML = '<div class="data-item">Solar wind data unavailable locally.</div>';
        }
      } catch(e){ showError(solarDataEl, 'Solar parse error'); }

      // Flares (noaa.solarFlares expected array)
      try {
        if (noaa && Array.isArray(noaa.solarFlares) && noaa.solarFlares.length) {
          const items = noaa.solarFlares.slice(-5).reverse().map(f => `<div class="data-item">${JSON.stringify(f)}</div>`).join('');
          xrayInfoEl.classList.remove('loading'); xrayInfoEl.innerHTML = items;
        } else {
          xrayInfoEl.classList.remove('loading'); xrayInfoEl.innerHTML = '<div class="data-item">No recent solar flares reported.</div>';
        }
      } catch(e){ xrayInfoEl.innerHTML = '<div class="error">Flare parse error</div>'; }

      // Dst - not present in your noaa-data.json sample -> show unavailable
      dstInfoEl.classList.remove('loading');
      dstInfoEl.innerHTML = '<div class="data-item">Dst not provided in local feed.</div>';
      dstValueEl.textContent = '--';
    }

    // Render aurora.json (you supplied the sample)
    function renderAurora(aurora) {
      try {
        if (!aurora) { auroraForecastEl.innerHTML = '<div class="data-item">Aurora forecast unavailable.</div>'; auroraMessageEl.textContent = 'Aurora forecast unavailable'; return; }
        // If aurora is an object with a forecast string
        if (typeof aurora === 'object' && aurora.forecast) {
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = `<div class="data-item"><strong>Updated:</strong> ${aurora.updated || ''}</div>
            <div class="data-item">${aurora.forecast}</div>
            <div style="color:var(--text-muted);font-size:0.9rem;margin-top:6px">Source: ${aurora.source || 'local'}</div>`;
          auroraMessageEl.textContent = aurora.forecast.split('.').slice(0,1)[0] + '.';
        } else if (Array.isArray(aurora) && aurora.length) {
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = aurora.slice(0,6).map(a => `<div class="data-item">${a.forecast || JSON.stringify(a)}</div>`).join('');
          auroraMessageEl.textContent = 'Aurora forecast loaded (local).';
        } else {
          auroraForecastEl.classList.remove('loading'); auroraForecastEl.innerHTML = '<div class="data-item">No aurora data</div>';
        }
      } catch(e){ auroraForecastEl.innerHTML = '<div class="error">Aurora parse error</div>'; auroraMessageEl.textContent = 'Aurora unavailable'; }
    }

    // Render news.json (array)
    function renderNews(news) {
      try {
        if (!news || !Array.isArray(news) || news.length === 0) { newsFeedEl.classList.remove('loading'); newsFeedEl.innerHTML = '<div class="data-item">No local news.</div>'; return; }
        newsFeedEl.classList.remove('loading');
        newsFeedEl.innerHTML = news.map(n => `<div class="data-item"><a href="${n.link || '#'}" target="_blank" style="color:var(--cyan)">${n.title || n.headline}</a>
          <div style="color:var(--text-muted);font-size:0.9rem">${n.date || n.published || ''} • ${n.source || ''}</div>
          <div style="color:var(--text-muted);font-size:0.95rem">${n.summary || ''}</div></div>`).join('');
      } catch(e){ newsFeedEl.innerHTML = '<div class="error">News parse error</div>'; }
    }

    // Render system status from update-status.json
    function renderStatus(statusObj) {
      try {
        if (!statusObj) { systemStatusEl.classList.remove('loading'); systemStatusEl.innerHTML = '<div class="data-item">No status file found.</div>'; return; }
        systemStatusEl.classList.remove('loading');
        const lines = [];
        lines.push(`<div class="data-item"><strong>LastUpdate:</strong> ${statusObj.lastUpdate || statusObj.updated || ''}</div>`);
        lines.push(`<div class="data-item"><strong>Status:</strong> ${statusObj.status || ''} • ${statusObj.message || ''}</div>`);
        if (Array.isArray(statusObj.dataSources)) lines.push(`<div class="data-item">Sources: ${statusObj.dataSources.join(', ')}</div>`);
        systemStatusEl.innerHTML = lines.join('');
      } catch(e){ systemStatusEl.innerHTML = '<div class="error">Status parse error</div>'; }
    }

    // ISS update (try local if present, else remote)
    async function updateISS() {
      // Try remote API (no local sample provided)
      try {
        const data = await fetchLocalOrRemote(null, 'https://api.wheretheiss.at/v1/satellites/25544');
        if (data && data.latitude && data.longitude) {
          issMarker.setLatLng([data.latitude, data.longitude]);
          // keep map centered but don't jump if user moved
          try { mapISS.setView([data.latitude, data.longitude], 3); } catch(e){}
        }
      } catch(e){ console.debug('ISS update error', e); }
    }

    // Main update function
    async function updateAll() {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Updating...';

      // Load local files (exact filenames you provided)
      const [noaa, aurora, news, status] = await Promise.all([
        fetchLocalOrRemote('./data/noaa-data.json'),
        fetchLocalOrRemote('./data/aurora.json'),
        fetchLocalOrRemote('./data/news.json'),
        fetchLocalOrRemote('./data/update-status.json')
      ]);

      // Render loaded data
      try { renderNOAAData(noaa); } catch(e){ console.debug(e); }
      try { renderAurora(aurora); } catch(e){ console.debug(e); }
      try { renderNews(news); } catch(e){ console.debug(e); }
      try { renderStatus(status); } catch(e){ console.debug(e); }

      // If some critical pieces missing, attempt remote fallbacks (gentle)
      // e.g., if noaa data missing, try NOAA endpoints (best-effort)
      if (!noaa) {
        // try to fetch KP from NOAA remote endpoint as fallback
        try {
          const kpRemote = await fetchLocalOrRemote(null, 'https://services.swpc.noaa.gov/json/planetary_k_index_1m.json');
          if (kpRemote && Array.isArray(kpRemote) && kpRemote.length) {
            const last = kpRemote[kpRemote.length-1];
            const kpVal = last.kp ?? last[1] ?? last[0];
            updateGauge(kpValueEl, kpArc, kpNeedle, Number(kpVal),0,9);
          }
        } catch(e){ console.debug('kp fallback failed', e); }
      }

      // ISS update
      await updateISS();

      // refresh TEC overlay to bypass cache
      try { tecLayer.setUrl('https://services.swpc.noaa.gov/products/noaa-maps/glotec.png?t=' + Date.now()); } catch(e){}

      // Finish UI
      updateTime.textContent = formatTime();
      lastRunEl.textContent = formatDate();
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
      refreshBtn.disabled = false;
    }

    // Init
    initMaps();
    updateAll();
    setInterval(updateAll, 120000);
    refreshBtn.addEventListener('click', updateAll);

    // make sure small-screen interactions are present (collapsible not necessary here but keep safe)
    document.addEventListener('DOMContentLoaded', () => {
      // Already initialized above
    });
  </script>
</body>
</html>
