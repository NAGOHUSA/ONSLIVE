<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Space Weather ‚Ä¢ ournightsky.us</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0a0e17;--card:rgba(20,25,45,0.75);--border:rgba(100,120,255,0.15);
      --text:#e6edf3;--text-muted:#94a3b8;--cyan:#00d4ff;--purple:#a855f7;
      --gold:#fbbf24;--red:#ef4444;--green:#10b981;
      --gradient:linear-gradient(135deg,#1e1b4b,#0f172a);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;min-height:100vh;
      color:var(--text);background:var(--gradient) fixed;line-height:1.6;}
    .container{max-width:1400px;margin:0 auto;padding:0 1rem;}
    header{position:sticky;top:0;z-index:1000;backdrop-filter:blur(20px);
      background:rgba(10,14,23,0.9);border-bottom:1px solid var(--border);padding:1rem 0;}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    h1{font-size:clamp(1.8rem,6vw,2.5rem);background:linear-gradient(135deg,var(--cyan),var(--purple));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    #refresh-btn{background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;
      padding:0.6rem 1.2rem;border-radius:40px;cursor:pointer;font-weight:600;transition:opacity 0.3s}
    #refresh-btn:hover{opacity:0.9}
    #refresh-btn:disabled{opacity:0.5;cursor:not-allowed}
    .hero{margin:2rem auto;text-align:center;padding:clamp(1.5rem,5vw,2.5rem);background:var(--card);
      border-radius:24px;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .gauge-container{width:min(90vw,300px);height:min(50vw,170px);margin:1.5rem auto;position:relative}
    .gauge-value{font-weight:800;position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);pointer-events:none;font-size:2rem}
    .needle{position:absolute;bottom:12%;left:50%;width:2px;height:38%;background:var(--red);
      transform-origin:bottom center;transform:translateX(-50%) rotate(-90deg);transition:transform 1s,background .4s}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1.5rem;margin-top:2rem}
    .card{background:var(--card);border-radius:20px;padding:1.5rem;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .map-controls{position:absolute;top:12px;right:12px;z-index:1000;display:flex;gap:8px}
    .map-btn{background:rgba(0,0,0,0.7);color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;transition:background 0.3s}
    .map-btn:hover{background:rgba(0,0,0,0.9)}
    .map-btn.active{background:var(--purple)}
    .data-item{padding:0.8rem;border-radius:8px;margin:0.5rem 0;background:rgba(255,255,255,0.03);border-left:4px solid var(--gold)}
    .alert-item{border-left-color:var(--red)}
    .warning-item{border-left-color:var(--gold)}
    .success-item{border-left-color:var(--green)}
    .loading{padding:2rem;text-align:center;color:var(--text-muted)}
    .error{color:var(--red);padding:1rem;border-radius:8px;background:rgba(239,68,68,0.1)}
    .success{color:var(--green)}
    footer{text-align:center;padding:3rem 1rem;margin-top:4rem;color:var(--text-muted);border-top:1px solid var(--border)}
    .data-source{font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem}
    .flare-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:0.75rem;margin-left:8px}
    .flare-a{background:#10b981;color:white}
    .flare-b{background:#3b82f6;color:white}
    .flare-c{background:#f59e0b;color:white}
    .flare-m{background:#ef4444;color:white}
    .flare-x{background:#7c3aed;color:white}
    .map-error{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:var(--text-muted);z-index:1000}
    .aurora-legend{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.7);padding:8px 12px;border-radius:8px;color:white;font-size:0.8rem;z-index:1000}
    @media(max-width:768px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1><i class="fas fa-satellite"></i> live.ournightsky.us 1.2</h1>
      <div style="display:flex;gap:1rem;align-items:center;color:var(--text-muted)">
        <span>Last updated: <strong id="update-time">--:--</strong></span>
        <button id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h2><i class="fas fa-compass"></i> Current Space Weather Activity</h2>
      <div class="gauge-container" id="kp-gauge">
        <svg viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="kp-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient>
          </defs>
          <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"></path>
          <path id="kp-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#kp-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
          <circle cx="100" cy="100" r="8" fill="#fff"></circle>
          <text x="100" y="65" text-anchor="middle" class="gauge-value" id="kp-value">--</text>
        </svg>
        <div class="needle" id="kp-needle"></div>
      </div>
      <p id="aurora-message" style="margin-top:1rem;color:var(--text-muted)">Loading aurora summary...</p>
    </section>

    <section class="card" style="grid-column:1/-1;position:relative">
      <h2><i class="fas fa-map"></i> Live Aurora Oval Map</h2>
      <div style="position:relative">
        <div class="map-controls">
          <button class="map-btn active" id="btn-north">Northern</button>
          <button class="map-btn" id="btn-south">Southern</button>
          <button class="map-btn" id="btn-refresh-map"><i class="fas fa-redo"></i></button>
        </div>
        <div id="aurora-map" style="height:360px;border-radius:12px;background:#000;position:relative"></div>
        <div id="map-error" class="map-error" style="display:none">
          <i class="fas fa-exclamation-triangle" style="font-size:2rem;color:var(--gold);margin-bottom:1rem"></i>
          <p>Aurora map temporarily unavailable</p>
          <p style="font-size:0.9rem">Using alternative visualization</p>
        </div>
        <div class="aurora-legend" id="aurora-legend">
          <div><span style="color:#00ff00">‚ñ†</span> High Aurora Probability</div>
          <div><span style="color:#ffff00">‚ñ†</span> Medium Aurora Probability</div>
          <div><span style="color:#ff9900">‚ñ†</span> Low Aurora Probability</div>
        </div>
      </div>
      <small style="display:block;margin-top:8px;text-align:center;color:var(--text-muted)">Real-time aurora forecast overlays ‚Ä¢ NOAA SWPC</small>
    </section>

    <div class="grid">
      <div class="card">
        <h2><i class="fas fa-sun"></i> Solar Activity</h2>
        <div id="solar-data" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
      </div>

      <div class="card">
        <h2><i class="fas fa-radiation"></i> Solar Radiation (X-ray)</h2>
        <div class="gauge-container" id="xray-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="xray-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="xray-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#xray-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="xray-value">--</text>
          </svg>
          <div class="needle" id="xray-needle"></div>
        </div>
        <div id="xray-info" class="loading"></div>
      </div>

      <div class="card">
        <h2><i class="fas fa-magnet"></i> Geomagnetic Storms (Dst)</h2>
        <div class="gauge-container" id="dst-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="dst-grad"><stop offset="0%" stop-color="#ef4444"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#10b981"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="dst-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#dst-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="dst-value">--</text>
          </svg>
          <div class="needle" id="dst-needle"></div>
        </div>
        <div id="dst-info" class="loading"></div>
      </div>

      <div class="card">
        <h2><i class="fas fa-satellite-dish"></i> ISS Tracking</h2>
        <div id="iss-map" style="height:300px;border-radius:12px;background:#000"></div>
        <small style="display:block;margin-top:8px;color:var(--text-muted)">Real-time International Space Station tracking</small>
      </div>

      <div class="card">
        <h2><i class="fas fa-cloud-aurora"></i> Aurora Forecast</h2>
        <div id="aurora-forecast" class="loading">Loading...</div>
      </div>

      <div class="card">
        <h2><i class="fas fa-newspaper"></i> Latest Space News</h2>
        <div id="news-feed" class="loading">Loading...</div>
      </div>

      <div class="card" style="grid-column:1/-1">
        <h2><i class="fas fa-info-circle"></i> System Status</h2>
        <div id="system-status" class="loading">Checking...</div>
      </div>
    </div>
  </main>

  <footer>
    <p>Part of <a href="https://ournightsky.us" style="color:var(--cyan)">ournightsky.us</a> ‚Ä¢ Data: NOAA, NASA, & Aurora Service</p>
    <p>Auto-refresh every 2 minutes ‚Ä¢ Last run: <span id="last-run">--</span></p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // DOM Elements
    const updateTime = document.getElementById('update-time');
    const refreshBtn = document.getElementById('refresh-btn');
    const lastRunEl = document.getElementById('last-run');

    const kpValueEl = document.getElementById('kp-value');
    const kpArc = document.getElementById('kp-arc');
    const kpNeedle = document.getElementById('kp-needle');
    const auroraMessageEl = document.getElementById('aurora-message');

    const dstValueEl = document.getElementById('dst-value');
    const dstArc = document.getElementById('dst-arc');
    const dstNeedle = document.getElementById('dst-needle');
    const dstInfoEl = document.getElementById('dst-info');

    const xrayValueEl = document.getElementById('xray-value');
    const xrayArc = document.getElementById('xray-arc');
    const xrayNeedle = document.getElementById('xray-needle');
    const xrayInfoEl = document.getElementById('xray-info');

    const solarDataEl = document.getElementById('solar-data');
    const auroraForecastEl = document.getElementById('aurora-forecast');
    const newsFeedEl = document.getElementById('news-feed');
    const systemStatusEl = document.getElementById('system-status');
    const mapErrorEl = document.getElementById('map-error');

    // Leaflet maps
    let mapAurora, auroraLayerNorth, auroraLayerSouth, currentAuroraLayer;
    let mapISS, issMarker;

    // Data URLs
    const DATA_URLS = {
      noaa: 'data/noaa-data.json',
      aurora: 'data/aurora.json',
      news: 'data/news.json',
      status: 'data/update-status.json',
      xray: 'data/xray-data.json',
      dst: 'data/dst-data.json'
    };

    // Aurora map URLs - multiple fallback options
    const AURORA_MAP_URLS = {
      north: [
        'https://services.swpc.noaa.gov/products/aurora/aurora-northern-hemisphere.jpg',
        'https://services.swpc.noaa.gov/images/aurora-forecast-northern-hemisphere.jpg',
        'https://www.swpc.noaa.gov/sites/default/files/images/aurora-forecast-northern-hemisphere.jpg',
        'https://services.swpc.noaa.gov/products/images/aurora-forecast-northern-hemisphere.jpg'
      ],
      south: [
        'https://services.swpc.noaa.gov/products/aurora/aurora-southern-hemisphere.jpg',
        'https://services.swpc.noaa.gov/images/aurora-forecast-southern-hemisphere.jpg',
        'https://www.swpc.noaa.gov/sites/default/files/images/aurora-forecast-southern-hemisphere.jpg',
        'https://services.swpc.noaa.gov/products/images/aurora-forecast-southern-hemisphere.jpg'
      ]
    };

    // Utility Functions
    function formatTime(date = new Date()) {
      return date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false});
    }

    function formatDate(date = new Date()) {
      return date.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
    }

    function formatDateString(dateString) {
      if (!dateString || dateString.includes('2024-01-01') || dateString.includes('never')) {
        return 'Never';
      }
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid date';
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return 'Date error';
      }
    }

    // Test image URL before using it
    async function testImageUrl(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url + '?t=' + Date.now();
        setTimeout(() => resolve(false), 3000); // Timeout after 3 seconds
      });
    }

    // Find working aurora image URL
    async function findWorkingAuroraUrl(urls) {
      for (const url of urls) {
        const isWorking = await testImageUrl(url);
        if (isWorking) {
          console.log('Found working aurora URL:', url);
          return url;
        }
      }
      return null;
    }

    // Data Fetching
    async function fetchLocalOrRemote(localPath, remoteUrl = null) {
      // Try local first with cache busting
      if (localPath) {
        try {
          const res = await fetch(localPath + '?t=' + Date.now());
          if (res.ok) {
            const txt = await res.text();
            try {
              return JSON.parse(txt);
            } catch (e) {
              console.warn('JSON parse failed for', localPath, e);
              return txt;
            }
          }
        } catch (e) {
          console.debug('Local fetch failed', localPath, e);
        }
      }
      
      // Fallback to remote
      if (remoteUrl) {
        try {
          const res2 = await fetch(remoteUrl + '?t=' + Date.now());
          if (res2.ok) {
            const txt = await res2.text();
            try {
              return JSON.parse(txt);
            } catch (e) {
              console.warn('JSON parse failed for remote', remoteUrl, e);
              return txt;
            }
          }
        } catch (e) {
          console.debug('Remote fetch failed', remoteUrl, e);
        }
      }
      
      return null;
    }

    // Gauge Helper
    function updateGauge(valueEl, arcEl, needleEl, val, min = 0, max = 9, unit = '', reverse = false) {
      const numeric = Number(val);
      let percent = Number.isFinite(numeric) ? (numeric - min) / (max - min) : 0;
      if (reverse) percent = 1 - percent;
      percent = Math.max(0, Math.min(1, percent));
      const deg = percent * 180 - 90;
      
      if (Number.isFinite(numeric)) {
        valueEl.textContent = Math.round(numeric * 10) / 10 + (unit || '');
      } else {
        valueEl.textContent = '--';
      }
      
      arcEl.setAttribute('stroke-dasharray', `${percent * 251.3}, 251.3`);
      needleEl.style.transform = `translateX(-50%) rotate(${deg}deg)`;
      needleEl.style.background = percent > 0.66 ? 'var(--red)' : percent > 0.33 ? 'var(--gold)' : 'var(--green)';
    }

    // Initialize Maps with fallback aurora images
    async function initMaps() {
      // Aurora Map
      mapAurora = L.map('aurora-map', {
        center: [80, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 5,
        worldCopyJump: true,
        attributionControl: false
      });
      
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri'
      }).addTo(mapAurora);
      
      // Try to find working aurora image URLs
      const workingNorthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.north);
      const workingSouthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.south);
      
      if (workingNorthUrl) {
        auroraLayerNorth = L.imageOverlay(
          workingNorthUrl,
          [[90, -180], [30, 180]],
          { opacity: 0.7 }
        ).addTo(mapAurora);
        currentAuroraLayer = auroraLayerNorth;
        mapErrorEl.style.display = 'none';
      } else {
        showAuroraFallback();
      }
      
      if (workingSouthUrl) {
        auroraLayerSouth = L.imageOverlay(
          workingSouthUrl,
          [[-30, -180], [-90, 180]],
          { opacity: 0.7 }
        );
      }

      // ISS Map
      mapISS = L.map('iss-map', {
        center: [0, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 8,
        attributionControl: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
      }).addTo(mapISS);
      
      const issIcon = L.icon({
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/ISS_insignia.svg/120px-ISS_insignia.svg.png',
        iconSize: [48, 48]
      });
      
      issMarker = L.marker([0, 0], { icon: issIcon }).addTo(mapISS);
    }

    // Show fallback aurora visualization
    function showAuroraFallback() {
      mapErrorEl.style.display = 'block';
      
      // Create a simple aurora oval visualization using Leaflet circles
      if (mapAurora) {
        // Clear any existing overlays
        mapAurora.eachLayer((layer) => {
          if (layer instanceof L.ImageOverlay || layer instanceof L.Circle) {
            mapAurora.removeLayer(layer);
          }
        });
        
        // Create simulated aurora oval based on Kp index
        const kp = parseFloat(kpValueEl.textContent) || 3;
        const ovalRadius = 20 + (kp * 5); // Scale with Kp
        
        // Create aurora oval (simplified)
        L.circle([80, 0], {
          radius: ovalRadius * 100000,
          fillColor: kp >= 5 ? '#00ff00' : kp >= 4 ? '#ffff00' : '#ff9900',
          fillOpacity: 0.3,
          color: '#00ff00',
          weight: 2
        }).addTo(mapAurora);
        
        // Add some random aurora "patches"
        for (let i = 0; i < 10; i++) {
          const lat = 70 + Math.random() * 20;
          const lng = -180 + Math.random() * 360;
          L.circle([lat, lng], {
            radius: 200000 + Math.random() * 300000,
            fillColor: kp >= 5 ? '#00ff00' : '#ffff00',
            fillOpacity: 0.2 + Math.random() * 0.3,
            color: 'transparent'
          }).addTo(mapAurora);
        }
      }
    }

    // Map Controls
    function setupMapControls() {
      document.getElementById('btn-north').addEventListener('click', async () => {
        try {
          mapAurora.setView([80, 0], 2);
          if (auroraLayerNorth) {
            if (currentAuroraLayer) mapAurora.removeLayer(currentAuroraLayer);
            auroraLayerNorth.addTo(mapAurora);
            currentAuroraLayer = auroraLayerNorth;
            mapErrorEl.style.display = 'none';
          } else {
            showAuroraFallback();
          }
        } catch (e) {
          showAuroraFallback();
        }
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-north').classList.add('active');
      });

      document.getElementById('btn-south').addEventListener('click', async () => {
        try {
          mapAurora.setView([-80, 0], 2);
          if (auroraLayerSouth) {
            if (currentAuroraLayer) mapAurora.removeLayer(currentAuroraLayer);
            auroraLayerSouth.addTo(mapAurora);
            currentAuroraLayer = auroraLayerSouth;
            mapErrorEl.style.display = 'none';
          } else {
            showAuroraFallback();
          }
        } catch (e) {
          showAuroraFallback();
        }
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-south').classList.add('active');
      });

      document.getElementById('btn-refresh-map').addEventListener('click', async () => {
        const btn = document.getElementById('btn-refresh-map');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Try to reload aurora images
        const workingNorthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.north);
        const workingSouthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.south);
        
        if (workingNorthUrl && auroraLayerNorth) {
          auroraLayerNorth.setUrl(workingNorthUrl + '?t=' + Date.now());
        }
        
        if (workingSouthUrl && auroraLayerSouth) {
          auroraLayerSouth.setUrl(workingSouthUrl + '?t=' + Date.now());
        }
        
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-redo"></i>';
        }, 1000);
      });
    }

    // Data Rendering Functions
    function renderNOAAData(noaaData, xrayData, dstData) {
      try {
        // Kp Gauge
        if (noaaData && Array.isArray(noaaData.kpIndex) && noaaData.kpIndex.length > 0) {
          const lastKp = noaaData.kpIndex[noaaData.kpIndex.length - 1];
          const kpValue = parseFloat(lastKp[1]) || parseFloat(lastKp.kp) || 0;
          
          updateGauge(kpValueEl, kpArc, kpNeedle, kpValue, 0, 9);
          
          // Aurora message based on Kp
          if (kpValue >= 6) {
            auroraMessageEl.innerHTML = `<span style="color:var(--red)">üåå AURORA ALERT! Kp ${kpValue.toFixed(1)} - Visible at mid-latitudes!</span>`;
          } else if (kpValue >= 5) {
            auroraMessageEl.innerHTML = `<span style="color:var(--gold)">‚ú® Aurora likely at high latitudes (Kp ${kpValue.toFixed(1)})</span>`;
          } else if (kpValue >= 4) {
            auroraMessageEl.innerHTML = `<span style="color:var(--cyan)">üí´ Aurora possible at polar regions (Kp ${kpValue.toFixed(1)})</span>`;
          } else {
            auroraMessageEl.innerHTML = `<span style="color:var(--text-muted)">Quiet aurora conditions (Kp ${kpValue.toFixed(1)})</span>`;
          }
        } else {
          kpValueEl.textContent = '--';
          auroraMessageEl.textContent = 'Kp data unavailable';
        }

        // Solar Wind
        let solarWindHtml = '';
        if (noaaData && Array.isArray(noaaData.solarWind) && noaaData.solarWind.length >= 3) {
          const [timestamp, density, speed, temperature] = noaaData.solarWind;
          solarWindHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-wind"></i> Solar Wind</strong>
              <div style="margin-top: 8px;">
                <div>Speed: <strong style="color:var(--cyan)">${speed} km/s</strong></div>
                <div>Density: ${density} p/cm¬≥</div>
                ${temperature ? `<div>Temperature: ${temperature} K</div>` : ''}
              </div>
              <div class="data-source">Updated: ${formatDateString(timestamp)}</div>
            </div>
          `;
        } else if (noaaData && noaaData.solarWind && typeof noaaData.solarWind === 'object') {
          solarWindHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-wind"></i> Solar Wind</strong>
              <div style="margin-top: 8px;">
                <div>Speed: <strong style="color:var(--cyan)">${noaaData.solarWind.speed || '--'} km/s</strong></div>
                <div>Density: ${noaaData.solarWind.density || '--'} p/cm¬≥</div>
              </div>
            </div>
          `;
        }

        // Solar Flares
        let flaresHtml = '';
        if (noaaData && Array.isArray(noaaData.solarFlares) && noaaData.solarFlares.length > 0) {
          const flares = noaaData.solarFlares.slice(-3).reverse();
          flaresHtml = '<div style="margin-top: 1rem;"><strong>Recent Solar Flares:</strong></div>';
          
          flares.forEach(flare => {
            const flareClass = flare.class_type || flare.class || 'Unknown';
            const flareTime = flare.begin_time || flare.peak_time || '';
            const flareLetter = flareClass.charAt(0).toUpperCase();
            const flareBadgeClass = `flare-${flareLetter.toLowerCase()}`;
            const isMajor = ['M', 'X'].includes(flareLetter);
            
            flaresHtml += `
              <div class="data-item ${isMajor ? 'alert-item' : 'warning-item'}">
                <strong>
                  ${flareClass} Class Flare
                  <span class="flare-badge ${flareBadgeClass}">${flareLetter}</span>
                </strong>
                <div>${formatDateString(flareTime)}</div>
              </div>
            `;
          });
        } else {
          flaresHtml = '<div class="data-item">No recent solar flares detected</div>';
        }

        solarDataEl.classList.remove('loading');
        solarDataEl.innerHTML = solarWindHtml + flaresHtml;

      } catch (e) {
        console.error('Error rendering NOAA data:', e);
        solarDataEl.innerHTML = '<div class="error">Error loading solar data</div>';
      }
    }

    function renderXrayData(xrayData) {
      try {
        if (xrayData && xrayData.current) {
          const numericValue = xrayData.numeric || 0;
          const xrayClass = xrayData.class || 'A';
          
          // Scale for gauge (A0.0 to X10.0)
          let gaugeValue = numericValue;
          let maxValue = 10;
          
          if (xrayClass === 'A') {
            maxValue = 1;
          } else if (xrayClass === 'B') {
            maxValue = 1;
            gaugeValue = numericValue * 10;
          } else if (xrayClass === 'C') {
            maxValue = 10;
          } else if (xrayClass === 'M') {
            maxValue = 10;
          } else if (xrayClass === 'X') {
            maxValue = 20;
          }
          
          updateGauge(xrayValueEl, xrayArc, xrayNeedle, gaugeValue, 0, maxValue);
          
          let statusColor = 'var(--green)';
          let statusIcon = '‚úì';
          if (xrayClass === 'M' || xrayClass === 'X') {
            statusColor = 'var(--red)';
            statusIcon = '‚ö†Ô∏è';
          } else if (xrayClass === 'C') {
            statusColor = 'var(--gold)';
            statusIcon = '‚ö†Ô∏è';
          }
          
          xrayInfoEl.classList.remove('loading');
          xrayInfoEl.innerHTML = `
            <div class="data-item" style="border-left-color: ${statusColor}">
              <strong>${statusIcon} X-ray Flux: ${xrayData.current}</strong>
              <div>${xrayData.description || 'Normal solar activity'}</div>
              <div class="data-source">Updated: ${formatDateString(xrayData.updated)}</div>
            </div>
          `;
        } else {
          xrayInfoEl.classList.remove('loading');
          xrayInfoEl.innerHTML = '<div class="data-item">X-ray data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering X-ray data:', e);
        xrayInfoEl.innerHTML = '<div class="error">Error loading X-ray data</div>';
      }
    }

    function renderDstData(dstData) {
      try {
        if (dstData && typeof dstData.current === 'number') {
          const dstValue = dstData.current;
          
          // For Dst, we use reverse gauge (higher negative = worse storm)
          const absValue = Math.abs(dstValue);
          updateGauge(dstValueEl, dstArc, dstNeedle, absValue, 0, 100, '', true);
          
          let stormLevel = dstData.stormLevel || 'Quiet';
          let statusClass = 'success-item';
          
          if (stormLevel === 'Severe') {
            statusClass = 'alert-item';
          } else if (stormLevel === 'Strong') {
            statusClass = 'alert-item';
          } else if (stormLevel === 'Moderate') {
            statusClass = 'warning-item';
          } else if (stormLevel === 'Minor') {
            statusClass = 'warning-item';
          }
          
          dstInfoEl.classList.remove('loading');
          dstInfoEl.innerHTML = `
            <div class="data-item ${statusClass}">
              <strong><i class="fas fa-magnet"></i> Dst Index: ${dstValue} nT</strong>
              <div><strong>${stormLevel}</strong> geomagnetic conditions</div>
              <div>${dstData.description || 'Normal geomagnetic activity'}</div>
              <div class="data-source">Updated: ${formatDateString(dstData.updated)}</div>
            </div>
          `;
        } else {
          dstInfoEl.classList.remove('loading');
          dstInfoEl.innerHTML = '<div class="data-item">Dst data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering Dst data:', e);
        dstInfoEl.innerHTML = '<div class="error">Error loading Dst data</div>';
      }
    }

    function renderAuroraData(auroraData) {
      try {
        if (!auroraData) {
          auroraForecastEl.innerHTML = '<div class="data-item">Aurora forecast unavailable</div>';
          return;
        }

        if (typeof auroraData === 'object' && auroraData.forecast) {
          let statusColor = 'var(--text-muted)';
          let statusIcon = 'üåå';
          
          if (auroraData.kpIndex >= 5) {
            statusColor = 'var(--gold)';
            statusIcon = '‚ú®';
          } else if (auroraData.kpIndex >= 4) {
            statusColor = 'var(--cyan)';
            statusIcon = 'üí´';
          }
          
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = `
            <div class="data-item" style="border-left-color: ${statusColor}">
              <strong>${statusIcon} Aurora Forecast (Kp ${auroraData.kpIndex || '?'})</strong>
              <div style="margin: 0.5rem 0">${auroraData.forecast}</div>
              <div><strong>Probability:</strong> ${auroraData.probability || 'Unknown'}</div>
              <div><strong>Best Viewing:</strong> ${auroraData.bestViewing || 'Unknown'}</div>
              <div class="data-source">Source: ${auroraData.source || 'NOAA'} ‚Ä¢ Updated: ${formatDateString(auroraData.updated)}</div>
            </div>
          `;
        } else {
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = '<div class="data-item">Aurora data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering aurora data:', e);
        auroraForecastEl.innerHTML = '<div class="error">Error loading aurora data</div>';
      }
    }

    function renderNewsData(newsData) {
      try {
        if (!newsData || !Array.isArray(newsData) || newsData.length === 0) {
          newsFeedEl.classList.remove('loading');
          newsFeedEl.innerHTML = '<div class="data-item">No recent space news</div>';
          return;
        }

        const newsItems = newsData.slice(0, 5).map(item => `
          <div class="data-item">
            <a href="${item.link || '#'}" target="_blank" rel="noopener" style="color:var(--cyan); text-decoration: none;">
              <strong>${item.title || 'Untitled'}</strong>
            </a>
            <div style="color:var(--text-muted); font-size: 0.9rem; margin: 0.25rem 0">
              <i class="fas fa-newspaper"></i> ${item.source || 'Unknown'} ‚Ä¢ ${formatDateString(item.date)}
            </div>
            <div style="color:var(--text-muted); font-size: 0.95rem">
              ${item.summary || ''}
            </div>
          </div>
        `).join('');

        newsFeedEl.classList.remove('loading');
        newsFeedEl.innerHTML = newsItems;
      } catch (e) {
        console.error('Error rendering news data:', e);
        newsFeedEl.innerHTML = '<div class="error">Error loading news</div>';
      }
    }

    function renderStatusData(statusData) {
      try {
        if (!statusData) {
          systemStatusEl.classList.remove('loading');
          systemStatusEl.innerHTML = '<div class="data-item">Status unavailable</div>';
          return;
        }

        const isSuccess = statusData.status === 'success';
        const isError = statusData.status === 'error';
        
        let statusHtml = '';
        
        if (isSuccess) {
          statusHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-check-circle"></i> System Online</strong>
              <div>${statusData.message || 'All systems operational'}</div>
              <div class="data-source">Last update: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        } else if (isError) {
          statusHtml = `
            <div class="data-item alert-item">
              <strong><i class="fas fa-exclamation-triangle"></i> System Error</strong>
              <div>${statusData.message || 'Unknown error'}</div>
              <div class="data-source">Last attempt: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        } else {
          statusHtml = `
            <div class="data-item warning-item">
              <strong><i class="fas fa-sync-alt fa-spin"></i> System Updating</strong>
              <div>${statusData.message || 'Fetching latest data'}</div>
              <div class="data-source">Last update: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        }

        // Add data sources if available
        if (statusData.dataSources && Array.isArray(statusData.dataSources) && statusData.dataSources.length > 0) {
          statusHtml += `
            <div class="data-item" style="margin-top: 1rem">
              <strong>Active Data Sources:</strong>
              <div style="margin-top: 0.5rem">
                ${statusData.dataSources.map(source => `
                  <div style="color:var(--text-muted); font-size: 0.9rem">
                    <i class="fas fa-check" style="color:var(--green)"></i> ${source}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        systemStatusEl.classList.remove('loading');
        systemStatusEl.innerHTML = statusHtml;

        // Update last run time
        if (lastRunEl && statusData.lastUpdate) {
          lastRunEl.textContent = formatDateString(statusData.lastUpdate);
        }
        
        // Update main timestamp
        if (statusData.lastUpdate && !statusData.lastUpdate.includes('2024-01-01')) {
          updateTime.textContent = formatTime(new Date(statusData.lastUpdate));
        } else {
          updateTime.textContent = formatTime();
        }
      } catch (e) {
        console.error('Error rendering status data:', e);
        systemStatusEl.innerHTML = '<div class="error">Error loading system status</div>';
      }
    }

    // ISS Tracking
    async function updateISS() {
      try {
        const data = await fetchLocalOrRemote(null, 'https://api.wheretheiss.at/v1/satellites/25544');
        if (data && data.latitude && data.longitude) {
          issMarker.setLatLng([data.latitude, data.longitude]);
          try {
            mapISS.setView([data.latitude, data.longitude], 3);
          } catch (e) {}
          
          // Update ISS marker tooltip
          issMarker.bindPopup(`
            <strong>International Space Station</strong><br>
            Latitude: ${data.latitude.toFixed(2)}¬∞<br>
            Longitude: ${data.longitude.toFixed(2)}¬∞<br>
            Altitude: ${(data.altitude || 0).toFixed(0)} km<br>
            Velocity: ${(data.velocity || 0).toFixed(0)} km/h<br>
            <small>Updated: ${formatTime()}</small>
          `).openPopup();
        }
      } catch (e) {
        console.debug('ISS update error:', e);
      }
    }

    // Main Update Function
    async function updateAll() {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Updating...';

      try {
        // Load all data files
        const [noaaData, auroraData, newsData, statusData, xrayData, dstData] = await Promise.all([
          fetchLocalOrRemote(DATA_URLS.noaa),
          fetchLocalOrRemote(DATA_URLS.aurora),
          fetchLocalOrRemote(DATA_URLS.news),
          fetchLocalOrRemote(DATA_URLS.status),
          fetchLocalOrRemote(DATA_URLS.xray),
          fetchLocalOrRemote(DATA_URLS.dst)
        ]);

        // Render all data
        renderNOAAData(noaaData, xrayData, dstData);
        renderXrayData(xrayData);
        renderDstData(dstData);
        renderAuroraData(auroraData);
        renderNewsData(newsData);
        renderStatusData(statusData);
        
        // Update ISS position
        await updateISS();
        
        // Refresh aurora map images if they exist
        if (auroraLayerNorth) {
          const workingNorthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.north);
          if (workingNorthUrl) {
            auroraLayerNorth.setUrl(workingNorthUrl + '?t=' + Date.now());
            mapErrorEl.style.display = 'none';
          } else if (currentAuroraLayer === auroraLayerNorth) {
            showAuroraFallback();
          }
        }
        
        if (auroraLayerSouth) {
          const workingSouthUrl = await findWorkingAuroraUrl(AURORA_MAP_URLS.south);
          if (workingSouthUrl) {
            auroraLayerSouth.setUrl(workingSouthUrl + '?t=' + Date.now());
          }
        }

      } catch (error) {
        console.error('Error updating data:', error);
        
        // Show error state
        const errorHtml = `<div class="error">
          <strong>‚ö†Ô∏è Data Loading Error</strong>
          <div>Failed to load some data: ${error.message || 'Network error'}</div>
          <div style="font-size:0.9rem; margin-top:0.5rem">Check console for details or try refreshing</div>
        </div>`;
        
        solarDataEl.innerHTML = errorHtml;
        xrayInfoEl.innerHTML = errorHtml;
        dstInfoEl.innerHTML = errorHtml;
        auroraForecastEl.innerHTML = errorHtml;
        newsFeedEl.innerHTML = errorHtml;
        systemStatusEl.innerHTML = errorHtml;
      } finally {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        refreshBtn.disabled = false;
      }
    }

    // Initialize everything
    async function init() {
      // Initialize maps
      await initMaps();
      setupMapControls();
      
      // Set up refresh button
      refreshBtn.addEventListener('click', updateAll);
      
      // Auto-refresh every 2 minutes
      setInterval(updateAll, 120000);
      
      // Initial data load
      updateAll();
      
      // Show loading states
      updateTime.textContent = 'Loading...';
      lastRunEl.textContent = '--';
    }

    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
