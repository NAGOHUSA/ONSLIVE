<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cmp.gatekeeperconsent.com/min.js" data-cfasync="false"></script>
  <script src="https://the.gatekeeperconsent.com/cmp.min.js" data-cfasync="false"></script>
  <script async src="//www.ezojs.com/ezoic/sa.min.js"></script>
  <script>
    window.ezstandalone = window.ezstandalone || {};
    ezstandalone.cmd = ezstandalone.cmd || [];
  </script>
  <!-- Ezoic - incontent_5 - incontent_5 -->
  <div id="ezoic-pub-ad-placeholder-115"></div>
  <!-- End Ezoic - incontent_5 - incontent_5 -->
  <!-- Ezoic - long_content - long_content -->
  <div id="ezoic-pub-ad-placeholder-112"></div>
  <!-- End Ezoic - long_content - long_content -->
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0901537229802149" crossorigin="anonymous"></script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Space Weather ‚Ä¢ ournightsky.us</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0a0e17;--card:rgba(20,25,45,0.75);--border:rgba(100,120,255,0.15);
      --text:#e6edf3;--text-muted:#94a3b8;--cyan:#00d4ff;--purple:#a855f7;
      --gold:#fbbf24;--red:#ef4444;--green:#10b981;
      --gradient:linear-gradient(135deg,#1e1b4b,#0f172a);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;min-height:100vh;
      color:var(--text);background:var(--gradient) fixed;line-height:1.6;}
    .container{max-width:1400px;margin:0 auto;padding:0 1rem;}
    header{position:sticky;top:0;z-index:1000;backdrop-filter:blur(20px);
      background:rgba(10,14,23,0.9);border-bottom:1px solid var(--border);padding:1rem 0;}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    h1{font-size:clamp(1.8rem,6vw,2.5rem);background:linear-gradient(135deg,var(--cyan),var(--purple));
      -webkit-background-clip:text;background-clip:text;color:transparent}
    #refresh-btn{background:linear-gradient(135deg,var(--cyan),var(--purple));border:none;color:#fff;
      padding:0.6rem 1.2rem;border-radius:40px;cursor:pointer;font-weight:600;transition:opacity 0.3s}
    #refresh-btn:hover{opacity:0.9}
    #refresh-btn:disabled{opacity:0.5;cursor:not-allowed}
    .hero{margin:2rem auto;text-align:center;padding:clamp(1.5rem,5vw,2.5rem);background:var(--card);
      border-radius:24px;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .gauge-container{width:min(90vw,300px);height:min(50vw,170px);margin:1.5rem auto;position:relative}
    .gauge-value{font-weight:800;position:absolute;top:50%;left:50%;transform:translate(-50%,-60%);pointer-events:none;font-size:2rem}
    .needle{position:absolute;bottom:12%;left:50%;width:2px;height:38%;background:var(--red);
      transform-origin:bottom center;transform:translateX(-50%) rotate(-90deg);transition:transform 1s,background .4s}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:1.5rem;margin-top:2rem}
    .card{background:var(--card);border-radius:20px;padding:1.5rem;border:1px solid var(--border);backdrop-filter:blur(20px)}
    .map-controls{position:absolute;top:12px;right:12px;z-index:1000;display:flex;gap:8px}
    .map-btn{background:rgba(0,0,0,0.7);color:#fff;border:none;padding:8px 14px;border-radius:10px;cursor:pointer;transition:background 0.3s}
    .map-btn:hover{background:rgba(0,0,0,0.9)}
    .map-btn.active{background:var(--purple)}
    .data-item{padding:0.8rem;border-radius:8px;margin:0.5rem 0;background:rgba(255,255,255,0.03);border-left:4px solid var(--gold)}
    .alert-item{border-left-color:var(--red)}
    .warning-item{border-left-color:var(--gold)}
    .success-item{border-left-color:var(--green)}
    .loading{padding:2rem;text-align:center;color:var(--text-muted)}
    .error{color:var(--red);padding:1rem;border-radius:8px;background:rgba(239,68,68,0.1)}
    .success{color:var(--green)}
    footer{text-align:center;padding:3rem 1rem;margin-top:4rem;color:var(--text-muted);border-top:1px solid var(--border)}
    .data-source{font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem}
    .flare-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:0.75rem;margin-left:8px}
    .flare-a{background:#10b981;color:white}
    .flare-b{background:#3b82f6;color:white}
    .flare-c{background:#f59e0b;color:white}
    .flare-m{background:#ef4444;color:white}
    .flare-x{background:#7c3aed;color:white}
    .aurora-legend{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.7);padding:8px 12px;border-radius:8px;color:white;font-size:0.8rem;z-index:1000}
    .aurora-intensity{display:flex;align-items:center;margin-bottom:4px}
    .aurora-intensity span{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px}
    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    /* NEW: Improved main grid layout */
    .main-content-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    /* Make certain cards span full width */
    .card.full-width {
      grid-column: 1 / -1;
    }
    
    /* Adjust gauge containers for better fit */
    .card .gauge-container {
      width: min(100%, 280px);
    }
    
    @media(max-width:1100px) {
      .main-content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media(max-width:768px){
      .grid{grid-template-columns:1fr}
      .main-content-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <h1><i class="fas fa-satellite"></i> live.ournightsky.us 1.0</h1>
      <div style="display:flex;gap:1rem;align-items:center;color:var(--text-muted)">
        <span>Last updated: <strong id="update-time">--:--</strong></span>
        <button id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <!-- Aurora Map Card -->
      <div class="card full-width">
        <h2><i class="fas fa-map"></i> Live Aurora Oval Map</h2>
        <div style="position:relative">
          <div class="map-controls">
            <button class="map-btn active" id="btn-north">Northern</button>
            <button class="map-btn" id="btn-south">Southern</button>
            <button class="map-btn" id="btn-refresh-map"><i class="fas fa-redo"></i></button>
          </div>
          <div id="aurora-map" style="height:360px;border-radius:12px;background:#000;position:relative"></div>
          <div class="aurora-legend">
            <div style="font-weight:bold;margin-bottom:6px;color:#00ffaa">Aurora Intensity</div>
            <div class="aurora-intensity"><span style="background:#ff0066"></span> Extreme (Kp ‚â• 8)</div>
            <div class="aurora-intensity"><span style="background:#ff5500"></span> Strong (Kp 6-7)</div>
            <div class="aurora-intensity"><span style="background:#ffff00"></span> Moderate (Kp 4-5)</div>
            <div class="aurora-intensity"><span style="background:#00ffaa"></span> Low (Kp 0-3)</div>
          </div>
        </div>
        <small style="display:block;margin-top:8px;text-align:center;color:var(--text-muted)">Dynamic aurora visualization based on real-time Kp index</small>
      </div>

      <!-- News Feed Card (Full Width) -->
      <div class="card full-width">
        <h2><i class="fas fa-newspaper"></i> Latest Space News</h2>
        <div id="news-feed" class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- Current Space Weather Activity (Hero Section) -->
    <section class="hero">
      <h2><i class="fas fa-compass"></i> Current Space Weather Activity</h2>
      <div class="gauge-container" id="kp-gauge">
        <svg viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet">
          <defs>
            <linearGradient id="kp-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient>
          </defs>
          <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"></path>
          <path id="kp-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#kp-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
          <circle cx="100" cy="100" r="8" fill="#fff"></circle>
          <text x="100" y="65" text-anchor="middle" class="gauge-value" id="kp-value">--</text>
        </svg>
        <div class="needle" id="kp-needle"></div>
      </div>
      <p id="aurora-message" style="margin-top:1rem;color:var(--text-muted)">Loading aurora summary...</p>
    </section>

    <!-- NEW: Main content grid with 2-column layout -->
    <div class="main-content-grid">
      <!-- Solar Activity Card -->
      <div class="card">
        <h2><i class="fas fa-sun"></i> Solar Activity</h2>
        <div id="solar-data" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
      </div>

      <!-- X-ray Gauge Card -->
      <div class="card">
        <h2><i class="fas fa-radiation"></i> Solar Radiation (X-ray)</h2>
        <div class="gauge-container" id="xray-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="xray-grad"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#ef4444"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="xray-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#xray-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="xray-value">--</text>
          </svg>
          <div class="needle" id="xray-needle"></div>
        </div>
        <div id="xray-info" class="loading"></div>
      </div>

      <!-- Dst Gauge Card -->
      <div class="card">
        <h2><i class="fas fa-magnet"></i> Geomagnetic Storms (Dst)</h2>
        <div class="gauge-container" id="dst-gauge">
          <svg viewBox="0 0 200 120">
            <defs><linearGradient id="dst-grad"><stop offset="0%" stop-color="#ef4444"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#10b981"/></linearGradient></defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="dst-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#dst-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="dst-value">--</text>
          </svg>
          <div class="needle" id="dst-needle"></div>
        </div>
        <div id="dst-info" class="loading"></div>
      </div>

      <!-- ISS Tracking Card -->
      <div class="card">
        <h2><i class="fas fa-satellite-dish"></i> ISS Tracking</h2>
        <div id="iss-map" style="height:300px;border-radius:12px;background:#000"></div>
        <small style="display:block;margin-top:8px;color:var(--text-muted)">Real-time International Space Station tracking</small>
      </div>

      <!-- Meteor Shower Activity Card -->
      <div class="card">
        <h2><i class="fas fa-star-shooting"></i> Meteor Activity</h2>
        <div class="gauge-container" id="meteor-gauge">
          <svg viewBox="0 0 200 120">
            <defs>
              <linearGradient id="meteor-grad">
                <stop offset="0%" stop-color="#10b981"/>
                <stop offset="50%" stop-color="#fbbf24"/>
                <stop offset="100%" stop-color="#ef4444"/>
              </linearGradient>
            </defs>
            <path d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="#334155" stroke-width="16"/>
            <path id="meteor-arc" d="M20 100 A80 80 0 1 1 180 100" fill="none" stroke="url(#meteor-grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 251.3"></path>
            <circle cx="100" cy="100" r="8" fill="#fff"></circle>
            <text x="100" y="65" text-anchor="middle" class="gauge-value" id="meteor-value">--</text>
          </svg>
          <div class="needle" id="meteor-needle"></div>
        </div>
        <div id="meteor-info" class="loading"></div>
      </div>

      <!-- Aurora Forecast Card -->
      <div class="card">
        <h2><i class="fas fa-cloud-aurora"></i> Aurora Forecast</h2>
        <div id="aurora-forecast" class="loading">Loading...</div>
      </div>

      <!-- System Status Card -->
      <div class="card full-width">
        <h2><i class="fas fa-info-circle"></i> System Status</h2>
        <div id="system-status" class="loading">Checking...</div>
      </div>
    </div>
  </main>

  <!-- Ezoic - incontent_5 - incontent_5 -->
  <div id="ezoic-pub-ad-placeholder-115"></div>
  <!-- End Ezoic - incontent_5 - incontent_5 -->

  <footer>
    <p>Part of <a href="https://ournightsky.us" style="color:var(--cyan)">ournightsky.us</a> ‚Ä¢ Data: NOAA, NASA, & Aurora Service</p>
    <p>Auto-refresh every 2 minutes ‚Ä¢ Last run: <span id="last-run">--</span></p>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // DOM Elements
    const updateTime = document.getElementById('update-time');
    const refreshBtn = document.getElementById('refresh-btn');
    const lastRunEl = document.getElementById('last-run');

    const kpValueEl = document.getElementById('kp-value');
    const kpArc = document.getElementById('kp-arc');
    const kpNeedle = document.getElementById('kp-needle');
    const auroraMessageEl = document.getElementById('aurora-message');

    const dstValueEl = document.getElementById('dst-value');
    const dstArc = document.getElementById('dst-arc');
    const dstNeedle = document.getElementById('dst-needle');
    const dstInfoEl = document.getElementById('dst-info');

    const xrayValueEl = document.getElementById('xray-value');
    const xrayArc = document.getElementById('xray-arc');
    const xrayNeedle = document.getElementById('xray-needle');
    const xrayInfoEl = document.getElementById('xray-info');

    const solarDataEl = document.getElementById('solar-data');
    const auroraForecastEl = document.getElementById('aurora-forecast');
    const newsFeedEl = document.getElementById('news-feed');
    const systemStatusEl = document.getElementById('system-status');

    const meteorValueEl = document.getElementById('meteor-value');
    const meteorArc = document.getElementById('meteor-arc');
    const meteorNeedle = document.getElementById('meteor-needle');
    const meteorInfoEl = document.getElementById('meteor-info');

    // Leaflet maps
    let mapAurora, mapISS, issMarker;
    let auroraCircles = [];

    // Data URLs - FIXED: Added correct meteor.json URL
    const DATA_URLS = {
      noaa: 'data/noaa-data.json',
      aurora: 'data/aurora.json',
      news: 'data/news.json',
      status: 'data/update-status.json',
      xray: 'data/xray-data.json',
      dst: 'data/dst-data.json',
      meteor: 'https://raw.githubusercontent.com/NAGOHUSA/ONSLIVE/main/data/meteor.json'  
    };

    // Meteor Data Rendering Function - FIXED VERSION
    function renderMeteorData(meteorData) {
      try {
        if (meteorData && typeof meteorData.current === 'number') {
          const meteorValue = meteorData.current;
          const maxValue = meteorData.max || 10;
          
          updateGauge(meteorValueEl, meteorArc, meteorNeedle, meteorValue, 0, maxValue);
          
          let activityClass = 'success-item';
          let activityIcon = 'üå†';
          let activityColor = 'var(--green)';
          
          if (meteorValue >= 7) {
            activityClass = 'alert-item';
            activityIcon = 'üåå';
            activityColor = 'var(--red)';
          } else if (meteorValue >= 5) {
            activityClass = 'warning-item';
            activityIcon = '‚ú®';
            activityColor = 'var(--gold)';
          } else if (meteorValue >= 3) {
            activityIcon = 'üí´';
            activityColor = 'var(--cyan)';
          }
          
          let activeShowersHtml = '';
          if (meteorData.activeShowers && Array.isArray(meteorData.activeShowers) && meteorData.activeShowers.length > 0) {
            activeShowersHtml = `
              <div style="margin-top: 1rem;">
                <strong>Active Showers:</strong>
                ${meteorData.activeShowers.map(shower => `
                  <div class="data-item" style="margin-top: 0.5rem; border-left-color: ${activityColor}">
                    <strong>${shower.name}</strong>
                    <div>Peak: ${shower.peak}</div>
                    <div>ZHR: ${shower.zhr} meteors/hour</div>
                    <div style="font-size: 0.9rem; color: var(--text-muted)">${shower.description}</div>
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          let nextShowerHtml = '';
          if (meteorData.nextMajorShower) {
            nextShowerHtml = `
              <div style="margin-top: 1rem;">
                <strong>Next Major Shower:</strong>
                <div class="data-item" style="margin-top: 0.5rem;">
                  <strong>${meteorData.nextMajorShower.name}</strong>
                  <div>Peak: ${meteorData.nextMajorShower.date}</div>
                  <div>ZHR: ${meteorData.nextMajorShower.zhr} meteors/hour</div>
                  <div style="font-size: 0.9rem; color: var(--text-muted)">${meteorData.nextMajorShower.description}</div>
                </div>
              </div>
            `;
          }
          
          meteorInfoEl.classList.remove('loading');
          meteorInfoEl.innerHTML = `
            <div class="data-item ${activityClass}" style="border-left-color: ${activityColor}">
              <strong>${activityIcon} Current Activity: ${meteorData.activity || 'Normal'}</strong>
              <div>${meteorData.description || 'Background meteor activity'}</div>
              <div class="data-source">Updated: ${formatDateString(meteorData.updated)}</div>
            </div>
            ${activeShowersHtml}
            ${nextShowerHtml}
          `;
        } else {
          meteorInfoEl.classList.remove('loading');
          meteorInfoEl.innerHTML = '<div class="data-item">Meteor data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering meteor data:', e);
        meteorInfoEl.innerHTML = '<div class="error">Error loading meteor data</div>';
      }
    }

    // Utility Functions
    function formatTime(date = new Date()) {
      return date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false});
    }

    function formatDate(date = new Date()) {
      return date.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'});
    }

    function formatDateString(dateString) {
      if (!dateString || dateString.includes('2024-01-01') || dateString.includes('never')) {
        return 'Never';
      }
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid date';
        return date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return 'Date error';
      }
    }

    // Data Fetching
    async function fetchLocalOrRemote(localPath, remoteUrl = null) {
      // Try local first with cache busting
      if (localPath && !localPath.startsWith('http')) {
        try {
          const res = await fetch(localPath + '?t=' + Date.now());
          if (res.ok) {
            const txt = await res.text();
            try {
              return JSON.parse(txt);
            } catch (e) {
              console.warn('JSON parse failed for', localPath, e);
              return txt;
            }
          }
        } catch (e) {
          console.debug('Local fetch failed', localPath, e);
        }
      } else if (localPath && localPath.startsWith('http')) {
        // Direct URL
        try {
          const res = await fetch(localPath + '?t=' + Date.now());
          if (res.ok) {
            const txt = await res.text();
            try {
              return JSON.parse(txt);
            } catch (e) {
              console.warn('JSON parse failed for direct URL', localPath, e);
              return txt;
            }
          }
        } catch (e) {
          console.debug('Direct URL fetch failed', localPath, e);
        }
      }
      
      // Fallback to remote
      if (remoteUrl) {
        try {
          const res2 = await fetch(remoteUrl + '?t=' + Date.now());
          if (res2.ok) {
            const txt = await res2.text();
            try {
              return JSON.parse(txt);
            } catch (e) {
              console.warn('JSON parse failed for remote', remoteUrl, e);
              return txt;
            }
          }
        } catch (e) {
          console.debug('Remote fetch failed', remoteUrl, e);
        }
      }
      
      return null;
    }

    // Gauge Helper
    function updateGauge(valueEl, arcEl, needleEl, val, min = 0, max = 9, unit = '', reverse = false) {
      const numeric = Number(val);
      let percent = Number.isFinite(numeric) ? (numeric - min) / (max - min) : 0;
      if (reverse) percent = 1 - percent;
      percent = Math.max(0, Math.min(1, percent));
      const deg = percent * 180 - 90;
      
      if (Number.isFinite(numeric)) {
        valueEl.textContent = Math.round(numeric * 10) / 10 + (unit || '');
      } else {
        valueEl.textContent = '--';
      }
      
      arcEl.setAttribute('stroke-dasharray', `${percent * 251.3}, 251.3`);
      needleEl.style.transform = `translateX(-50%) rotate(${deg}deg)`;
      needleEl.style.background = percent > 0.66 ? 'var(--red)' : percent > 0.33 ? 'var(--gold)' : 'var(--green)';
    }

    // Initialize Maps
    function initMaps() {
      // Aurora Map
      mapAurora = L.map('aurora-map', {
        center: [65, 0],
        zoom: 3,
        minZoom: 2,
        maxZoom: 5,
        worldCopyJump: true,
        attributionControl: false
      });
      
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri'
      }).addTo(mapAurora);

      // ISS Map
      mapISS = L.map('iss-map', {
        center: [0, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 8,
        attributionControl: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap'
      }).addTo(mapISS);
      
      const issIcon = L.icon({
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/ISS_insignia.svg/120px-ISS_insignia.svg.png',
        iconSize: [48, 48]
      });
      
      issMarker = L.marker([0, 0], { icon: issIcon }).addTo(mapISS);
    }

    // Create Aurora Visualization
    function createAuroraVisualization(kpValue = 3) {
      // Clear any existing aurora circles
      auroraCircles.forEach(circle => {
        if (circle && mapAurora) {
          mapAurora.removeLayer(circle);
        }
      });
      auroraCircles = [];
      
      if (!mapAurora) return;
      
      // Get current view center to determine hemisphere
      const center = mapAurora.getCenter();
      const isNorthern = center.lat > 0;
      
      // Determine colors based on Kp value
      let primaryColor, secondaryColor;
      if (kpValue >= 8) {
        primaryColor = '#ff0066';
        secondaryColor = '#ff3399';
      } else if (kpValue >= 6) {
        primaryColor = '#ff5500';
        secondaryColor = '#ff9900';
      } else if (kpValue >= 4) {
        primaryColor = '#ffff00';
        secondaryColor = '#ffff99';
      } else {
        primaryColor = '#00ffaa';
        secondaryColor = '#66ffcc';
      }
      
      // Base oval size based on Kp value
      const baseRadius = 15 + (kpValue * 3);
      const ovalRadius = baseRadius * 100000;
      
      // Create main aurora oval
      const centerLat = isNorthern ? 65 : -65;
      const mainOval = L.circle([centerLat, 0], {
        radius: ovalRadius,
        fillColor: primaryColor,
        fillOpacity: 0.4,
        color: primaryColor,
        weight: 2,
        opacity: 0.8
      }).addTo(mapAurora);
      
      auroraCircles.push(mainOval);
      
      // Create aurora "patches"
      const patchCount = Math.min(15, 5 + Math.floor(kpValue * 2));
      
      for (let i = 0; i < patchCount; i++) {
        const patchLat = isNorthern ? 
          (55 + Math.random() * 20) : 
          (-55 - Math.random() * 20);
        const patchLng = -180 + Math.random() * 360;
        const patchSize = (200000 + Math.random() * 400000) * (1 + kpValue / 10);
        const patchOpacity = 0.2 + Math.random() * 0.4;
        
        const auroraPatch = L.circle([patchLat, patchLng], {
          radius: patchSize,
          fillColor: secondaryColor,
          fillOpacity: patchOpacity,
          color: 'transparent',
          weight: 0
        }).addTo(mapAurora);
        
        auroraCircles.push(auroraPatch);
      }
      
      // Add pulsating effect
      if (kpValue >= 5) {
        setTimeout(() => {
          auroraCircles.forEach((circle, index) => {
            if (index > 0 && index % 3 === 0) {
              circle.setStyle({ fillOpacity: circle.options.fillOpacity * 1.5 });
              setTimeout(() => {
                circle.setStyle({ fillOpacity: circle.options.fillOpacity / 1.5 });
              }, 1000);
            }
          });
        }, 500);
      }
    }

    // Map Controls
    function setupMapControls() {
      document.getElementById('btn-north').addEventListener('click', () => {
        try {
          mapAurora.setView([65, 0], 3);
          createAuroraVisualization(parseFloat(kpValueEl.textContent) || 3);
        } catch (e) {
          console.error('Error switching to northern view:', e);
        }
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-north').classList.add('active');
      });

      document.getElementById('btn-south').addEventListener('click', () => {
        try {
          mapAurora.setView([-65, 0], 3);
          createAuroraVisualization(parseFloat(kpValueEl.textContent) || 3);
        } catch (e) {
          console.error('Error switching to southern view:', e);
        }
        document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-south').classList.add('active');
      });

      document.getElementById('btn-refresh-map').addEventListener('click', () => {
        const btn = document.getElementById('btn-refresh-map');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        const currentKp = parseFloat(kpValueEl.textContent) || 3;
        createAuroraVisualization(currentKp);
        
        setTimeout(() => {
          btn.innerHTML = '<i class="fas fa-redo"></i>';
        }, 1000);
      });
    }

    // Data Rendering Functions
    function renderNOAAData(noaaData, xrayData, dstData) {
      try {
        // Kp Gauge
        if (noaaData && Array.isArray(noaaData.kpIndex) && noaaData.kpIndex.length > 0) {
          const lastKp = noaaData.kpIndex[noaaData.kpIndex.length - 1];
          const kpValue = parseFloat(lastKp[1]) || parseFloat(lastKp.kp) || 0;
          
          updateGauge(kpValueEl, kpArc, kpNeedle, kpValue, 0, 9);
          
          // Update aurora message
          if (kpValue >= 8) {
            auroraMessageEl.innerHTML = `<span style="color:#ff0066">üåå EXTREME AURORA ALERT! Kp ${kpValue.toFixed(1)} - Visible worldwide!</span>`;
          } else if (kpValue >= 6) {
            auroraMessageEl.innerHTML = `<span style="color:var(--red)">üåå AURORA ALERT! Kp ${kpValue.toFixed(1)} - Visible at mid-latitudes!</span>`;
          } else if (kpValue >= 5) {
            auroraMessageEl.innerHTML = `<span style="color:var(--gold)">‚ú® Aurora likely at high latitudes (Kp ${kpValue.toFixed(1)})</span>`;
          } else if (kpValue >= 4) {
            auroraMessageEl.innerHTML = `<span style="color:var(--cyan)">üí´ Aurora possible at polar regions (Kp ${kpValue.toFixed(1)})</span>`;
          } else {
            auroraMessageEl.innerHTML = `<span style="color:var(--text-muted)">Quiet aurora conditions (Kp ${kpValue.toFixed(1)})</span>`;
          }
          
          // Update aurora visualization
          createAuroraVisualization(kpValue);
        } else {
          kpValueEl.textContent = '--';
          auroraMessageEl.textContent = 'Kp data unavailable';
          createAuroraVisualization(3);
        }

        // Solar Wind
        let solarWindHtml = '';
        if (noaaData && Array.isArray(noaaData.solarWind) && noaaData.solarWind.length >= 3) {
          const [timestamp, density, speed, temperature] = noaaData.solarWind;
          solarWindHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-wind"></i> Solar Wind</strong>
              <div style="margin-top: 8px;">
                <div>Speed: <strong style="color:var(--cyan)">${speed} km/s</strong></div>
                <div>Density: ${density} p/cm¬≥</div>
                ${temperature ? `<div>Temperature: ${temperature} K</div>` : ''}
              </div>
              <div class="data-source">Updated: ${formatDateString(timestamp)}</div>
            </div>
          `;
        } else if (noaaData && noaaData.solarWind && typeof noaaData.solarWind === 'object') {
          solarWindHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-wind"></i> Solar Wind</strong>
              <div style="margin-top: 8px;">
                <div>Speed: <strong style="color:var(--cyan)">${noaaData.solarWind.speed || '--'} km/s</strong></div>
                <div>Density: ${noaaData.solarWind.density || '--'} p/cm¬≥</div>
              </div>
            </div>
          `;
        }

        // Solar Flares
        let flaresHtml = '';
        if (noaaData && Array.isArray(noaaData.solarFlares) && noaaData.solarFlares.length > 0) {
          const flares = noaaData.solarFlares.slice(-3).reverse();
          flaresHtml = '<div style="margin-top: 1rem;"><strong>Recent Solar Flares:</strong></div>';
          
          flares.forEach(flare => {
            const flareClass = flare.class_type || flare.class || 'Unknown';
            const flareTime = flare.begin_time || flare.peak_time || '';
            const flareLetter = flareClass.charAt(0).toUpperCase();
            const flareBadgeClass = `flare-${flareLetter.toLowerCase()}`;
            const isMajor = ['M', 'X'].includes(flareLetter);
            
            flaresHtml += `
              <div class="data-item ${isMajor ? 'alert-item' : 'warning-item'}">
                <strong>
                  ${flareClass} Class Flare
                  <span class="flare-badge ${flareBadgeClass}">${flareLetter}</span>
                </strong>
                <div>${formatDateString(flareTime)}</div>
              </div>
            `;
          });
        } else {
          flaresHtml = '<div class="data-item">No recent solar flares detected</div>';
        }

        solarDataEl.classList.remove('loading');
        solarDataEl.innerHTML = solarWindHtml + flaresHtml;

      } catch (e) {
        console.error('Error rendering NOAA data:', e);
        solarDataEl.innerHTML = '<div class="error">Error loading solar data</div>';
        createAuroraVisualization(3);
      }
    }

    function renderXrayData(xrayData) {
      try {
        if (xrayData && xrayData.current) {
          const numericValue = xrayData.numeric || 0;
          const xrayClass = xrayData.class || 'A';
          
          let gaugeValue = numericValue;
          let maxValue = 10;
          
          if (xrayClass === 'A') {
            maxValue = 1;
          } else if (xrayClass === 'B') {
            maxValue = 1;
            gaugeValue = numericValue * 10;
          } else if (xrayClass === 'C') {
            maxValue = 10;
          } else if (xrayClass === 'M') {
            maxValue = 10;
          } else if (xrayClass === 'X') {
            maxValue = 20;
          }
          
          updateGauge(xrayValueEl, xrayArc, xrayNeedle, gaugeValue, 0, maxValue);
          
          let statusColor = 'var(--green)';
          let statusIcon = '‚úì';
          if (xrayClass === 'M' || xrayClass === 'X') {
            statusColor = 'var(--red)';
            statusIcon = '‚ö†Ô∏è';
          } else if (xrayClass === 'C') {
            statusColor = 'var(--gold)';
            statusIcon = '‚ö†Ô∏è';
          }
          
          xrayInfoEl.classList.remove('loading');
          xrayInfoEl.innerHTML = `
            <div class="data-item" style="border-left-color: ${statusColor}">
              <strong>${statusIcon} X-ray Flux: ${xrayData.current}</strong>
              <div>${xrayData.description || 'Normal solar activity'}</div>
              <div class="data-source">Updated: ${formatDateString(xrayData.updated)}</div>
            </div>
          `;
        } else {
          xrayInfoEl.classList.remove('loading');
          xrayInfoEl.innerHTML = '<div class="data-item">X-ray data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering X-ray data:', e);
        xrayInfoEl.innerHTML = '<div class="error">Error loading X-ray data</div>';
      }
    }

    function renderDstData(dstData) {
      try {
        if (dstData && typeof dstData.current === 'number') {
          const dstValue = dstData.current;
          
          const absValue = Math.abs(dstValue);
          updateGauge(dstValueEl, dstArc, dstNeedle, absValue, 0, 100, '', true);
          
          let stormLevel = dstData.stormLevel || 'Quiet';
          let statusClass = 'success-item';
          
          if (stormLevel === 'Severe') {
            statusClass = 'alert-item';
          } else if (stormLevel === 'Strong') {
            statusClass = 'alert-item';
          } else if (stormLevel === 'Moderate') {
            statusClass = 'warning-item';
          } else if (stormLevel === 'Minor') {
            statusClass = 'warning-item';
          }
          
          dstInfoEl.classList.remove('loading');
          dstInfoEl.innerHTML = `
            <div class="data-item ${statusClass}">
              <strong><i class="fas fa-magnet"></i> Dst Index: ${dstValue} nT</strong>
              <div><strong>${stormLevel}</strong> geomagnetic conditions</div>
              <div>${dstData.description || 'Normal geomagnetic activity'}</div>
              <div class="data-source">Updated: ${formatDateString(dstData.updated)}</div>
            </div>
          `;
        } else {
          dstInfoEl.classList.remove('loading');
          dstInfoEl.innerHTML = '<div class="data-item">Dst data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering Dst data:', e);
        dstInfoEl.innerHTML = '<div class="error">Error loading Dst data</div>';
      }
    }

    function renderAuroraData(auroraData) {
      try {
        if (!auroraData) {
          auroraForecastEl.innerHTML = '<div class="data-item">Aurora forecast unavailable</div>';
          return;
        }

        if (typeof auroraData === 'object' && auroraData.forecast) {
          let statusColor = 'var(--text-muted)';
          let statusIcon = 'üåå';
          
          if (auroraData.kpIndex >= 5) {
            statusColor = 'var(--gold)';
            statusIcon = '‚ú®';
          } else if (auroraData.kpIndex >= 4) {
            statusColor = 'var(--cyan)';
            statusIcon = 'üí´';
          }
          
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = `
            <div class="data-item" style="border-left-color: ${statusColor}">
              <strong>${statusIcon} Aurora Forecast (Kp ${auroraData.kpIndex || '?'})</strong>
              <div style="margin: 0.5rem 0">${auroraData.forecast}</div>
              <div><strong>Probability:</strong> ${auroraData.probability || 'Unknown'}</div>
              <div><strong>Best Viewing:</strong> ${auroraData.bestViewing || 'Unknown'}</div>
              <div class="data-source">Source: ${auroraData.source || 'NOAA'} ‚Ä¢ Updated: ${formatDateString(auroraData.updated)}</div>
            </div>
          `;
        } else {
          auroraForecastEl.classList.remove('loading');
          auroraForecastEl.innerHTML = '<div class="data-item">Aurora data updating...</div>';
        }
      } catch (e) {
        console.error('Error rendering aurora data:', e);
        auroraForecastEl.innerHTML = '<div class="error">Error loading aurora data</div>';
      }
    }

    function renderNewsData(newsData) {
      try {
        if (!newsData || !Array.isArray(newsData) || newsData.length === 0) {
          newsFeedEl.classList.remove('loading');
          newsFeedEl.innerHTML = '<div class="data-item">No recent space news</div>';
          return;
        }

        const newsItems = newsData.slice(0, 5).map(item => `
          <div class="data-item">
            <a href="${item.link || '#'}" target="_blank" rel="noopener" style="color:var(--cyan); text-decoration: none;">
              <strong>${item.title || 'Untitled'}</strong>
            </a>
            <div style="color:var(--text-muted); font-size: 0.9rem; margin: 0.25rem 0">
              <i class="fas fa-newspaper"></i> ${item.source || 'Unknown'} ‚Ä¢ ${formatDateString(item.date)}
            </div>
            <div style="color:var(--text-muted); font-size: 0.95rem">
              ${item.summary || ''}
            </div>
          </div>
        `).join('');

        newsFeedEl.classList.remove('loading');
        newsFeedEl.innerHTML = newsItems;
      } catch (e) {
        console.error('Error rendering news data:', e);
        newsFeedEl.innerHTML = '<div class="error">Error loading news</div>';
      }
    }

    function renderStatusData(statusData) {
      try {
        if (!statusData) {
          systemStatusEl.classList.remove('loading');
          systemStatusEl.innerHTML = '<div class="data-item">Status unavailable</div>';
          return;
        }

        const isSuccess = statusData.status === 'success';
        const isError = statusData.status === 'error';
        
        let statusHtml = '';
        
        if (isSuccess) {
          statusHtml = `
            <div class="data-item success-item">
              <strong><i class="fas fa-check-circle"></i> System Online</strong>
              <div>${statusData.message || 'All systems operational'}</div>
              <div class="data-source">Last update: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        } else if (isError) {
          statusHtml = `
            <div class="data-item alert-item">
              <strong><i class="fas fa-exclamation-triangle"></i> System Error</strong>
              <div>${statusData.message || 'Unknown error'}</div>
              <div class="data-source">Last attempt: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        } else {
          statusHtml = `
            <div class="data-item warning-item">
              <strong><i class="fas fa-sync-alt fa-spin"></i> System Updating</strong>
              <div>${statusData.message || 'Fetching latest data'}</div>
              <div class="data-source">Last update: ${formatDateString(statusData.lastUpdate)}</div>
            </div>
          `;
        }

        if (statusData.dataSources && Array.isArray(statusData.dataSources) && statusData.dataSources.length > 0) {
          statusHtml += `
            <div class="data-item" style="margin-top: 1rem">
              <strong>Active Data Sources:</strong>
              <div style="margin-top: 0.5rem">
                ${statusData.dataSources.map(source => `
                  <div style="color:var(--text-muted); font-size: 0.9rem">
                    <i class="fas fa-check" style="color:var(--green)"></i> ${source}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        systemStatusEl.classList.remove('loading');
        systemStatusEl.innerHTML = statusHtml;

        if (lastRunEl && statusData.lastUpdate) {
          lastRunEl.textContent = formatDateString(statusData.lastUpdate);
        }
        
        if (statusData.lastUpdate && !statusData.lastUpdate.includes('2024-01-01')) {
          updateTime.textContent = formatTime(new Date(statusData.lastUpdate));
        } else {
          updateTime.textContent = formatTime();
        }
      } catch (e) {
        console.error('Error rendering status data:', e);
        systemStatusEl.innerHTML = '<div class="error">Error loading system status</div>';
      }
    }

    // ISS Tracking
    async function updateISS() {
      try {
        const data = await fetchLocalOrRemote(null, 'https://api.wheretheiss.at/v1/satellites/25544');
        if (data && data.latitude && data.longitude) {
          issMarker.setLatLng([data.latitude, data.longitude]);
          try {
            mapISS.setView([data.latitude, data.longitude], 3);
          } catch (e) {}
          
          issMarker.bindPopup(`
            <strong>International Space Station</strong><br>
            Latitude: ${data.latitude.toFixed(2)}¬∞<br>
            Longitude: ${data.longitude.toFixed(2)}¬∞<br>
            Altitude: ${(data.altitude || 0).toFixed(0)} km<br>
            Velocity: ${(data.velocity || 0).toFixed(0)} km/h<br>
            <small>Updated: ${formatTime()}</small>
          `).openPopup();
        }
      } catch (e) {
        console.debug('ISS update error:', e);
      }
    }

    // Main Update Function - FIXED: Now includes meteor data
    async function updateAll() {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Updating...';

      try {
        // Load all data files - INCLUDING meteorData
        const [noaaData, auroraData, newsData, statusData, xrayData, dstData, meteorData] = await Promise.all([
          fetchLocalOrRemote(DATA_URLS.noaa),
          fetchLocalOrRemote(DATA_URLS.aurora),
          fetchLocalOrRemote(DATA_URLS.news),
          fetchLocalOrRemote(DATA_URLS.status),
          fetchLocalOrRemote(DATA_URLS.xray),
          fetchLocalOrRemote(DATA_URLS.dst),
          fetchLocalOrRemote(DATA_URLS.meteor)  // ‚úÖ Meteor data included
        ]);

        // Render all data - INCLUDING meteor data
        renderNOAAData(noaaData, xrayData, dstData);
        renderXrayData(xrayData);
        renderDstData(dstData);
        renderAuroraData(auroraData);
        renderNewsData(newsData);
        renderStatusData(statusData);
        renderMeteorData(meteorData);  // ‚úÖ Meteor rendering included
        
        // Update ISS position
        await updateISS();

      } catch (error) {
        console.error('Error updating data:', error);
        
        // Show error state - INCLUDING meteorInfoEl
        const errorHtml = `<div class="error">
          <strong>‚ö†Ô∏è Data Loading Error</strong>
          <div>Failed to load some data: ${error.message || 'Network error'}</div>
          <div style="font-size:0.9rem; margin-top:0.5rem">Check console for details or try refreshing</div>
        </div>`;
        
        solarDataEl.innerHTML = errorHtml;
        xrayInfoEl.innerHTML = errorHtml;
        dstInfoEl.innerHTML = errorHtml;
        auroraForecastEl.innerHTML = errorHtml;
        newsFeedEl.innerHTML = errorHtml;
        systemStatusEl.innerHTML = errorHtml;
        meteorInfoEl.innerHTML = errorHtml;  // ‚úÖ Meteor error included
      } finally {
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        refreshBtn.disabled = false;
      }
    }

    // Initialize everything
    function init() {
      // Initialize maps
      initMaps();
      setupMapControls();
      
      // Create initial aurora visualization
      createAuroraVisualization(3);
      
      // Set up refresh button
      refreshBtn.addEventListener('click', updateAll);
      
      // Auto-refresh every 2 minutes
      setInterval(updateAll, 120000);
      
      // Initial data load
      updateAll();
      
      // Show loading states
      updateTime.textContent = 'Loading...';
      lastRunEl.textContent = '--';
    }

    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
  <script src="https://www.dwin2.com/pub.2689578.min.js"></script>
  
<!-- START ADVERTISER: Piscifun from awin.com -->
<center>
<a rel="sponsored" href="https://www.awin1.com/cread.php?s=3978234&v=89509&q=522756&r=2689578">
    <img src="https://www.awin1.com/cshow.php?s=3978234&v=89509&q=522756&r=2689578" border="0">
</a>
</center>
<!-- END ADVERTISER: Piscifun from awin.com -->

</body>
</html>
